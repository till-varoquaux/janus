SHELL = /bin/sh
#Configurable options
SRC=Main
OCB=ocamlbuild -no-links -ocamlc "ocamlfind c" -ocamlopt "ocamlfind opt" -ocamldep "ocamlfind dep" -lflags "-package unix","-linkpkg"
#YACC=menhir
MODE=byte
FTP_TARGET=till.varoquaux@login.free.fr:/projects/$(PROJECT_NAME)
#end configurable options

BUILDDIR=_build

ifeq ($(TERM),dumb)
	OCB += -classic-display
endif

ifeq ($(YACC),menhir)
	OCB += -use-menhir -yaccflags --explain
else
	OCB += -yaccflags -v
endif
MLI=$(wildcard *.mli)

all:annot check

Makefile:configure
	${error Your Makefile is too old, you must rerun configure...}

.PHONY:all clean opt dist doc check annot web

$(TARGET):sane
	${info * making $(MODE) code}
	@$(OCB) $(SRC).$(MODE)
	@cp $(BUILDDIR)/$(SRC).$(MODE) $(TARGET)

doc:$(MLI)
	${info * making docs...}
	lp4all -p "$(PROJECT_NAME)" -d doc $$(darcs query manifest)
#	@echo "$(basename $(MLI))" > doc.odocl
#	@$(OCB) doc.docdir/index.html

check:$(TARGET)
	${info * runnning tests}
	@ocaml RunTests.ml ./$(TARGET)

sane:
	@rm -f *.annot

annot:$(TARGET)
	@cp _build/*.annot .

web:
	${info "updating web site"}
	@rm -rf web
	@darcs get . --repo-name=web
	@cd web;\
	lp4all -p "$(PROJECT_NAME)" $$(darcs query manifest);\
	rm -f sparsetable.py parsetable.py;\
	lftp -c "open $(FTP_TARGET); mirror -Renv --parallel=5 "

clean:sane
	${info * cleaning up}
	@rm -rf web doc
	@rm -f *~ \#* doc.odocl parsetab.py sparsetab.py
	@$(OCB) -clean

distclean:clean
	@rm -f Makefile version.ml

dist:
	darcs dist -d "$(PROJECT_NAME)-$(VERSION)"

